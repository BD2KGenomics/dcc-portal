#!/bin/bash
#
# Copyright 2013(c) The Ontario Institute for Cancer Research. All rights reserved.
#
# Description:
#   Downloads either a specified release verion or the latest snapshot from
#   artifactory, establishes the correct symlinks, clears the varnish cache and
#   restarts the application.
#
# Usage:
#  See usage()

# Enviromental configuation
cache=hcache-dev.res:5381

usage(){
cat << EOF
usage: $0 options

This script installs the dcc-portal-api from Artifactory, relinks the jar and restarts the daemon.

OPTIONS:
   -h         # Show this message
   -r version # Install release with version (use 'latest' for latest)
   -s version # Install snapshot with version (use 'latest' for latest)
   -p version # Install pr snapshot with version (use 'latest' for latest)
EOF
}

log(){
  echo `date` -  $1 | tee -a $logdir/install.log
}

release=
snapshot=
pr=
while getopts “:hr:s:p:” OPTION
do
  case $OPTION in
         h)
             usage
             exit 1
             ;;
         r)
             release=$(( $OPTARG == latest ? 1 : $OPTARG ))
             ;;
         s)
             snapshot=$(( $OPTARG == latest ? 1 : $OPTARG ))
             ;;
         p)
             pr=$(( $OPTARG == latest ? 1 : $OPTARG ))
             ;;
         ?)
             usage
             exit
             ;;
     esac
done

if [[ -z $release ]] && [[ -z $snapshot ]] && [[ -z $pr ]]
then
  usage
  exit 1
fi

# Output location
basedir=$(dirname $(readlink -m $(dirname $0i)))
bindir="$basedir/bin"
libdir="$basedir/lib"
logdir="$basedir/logs"

# Maven artifact location
name="dcc-portal-api"
server="http://seqwaremaven.oicr.on.ca/artifactory"
artifact="org/icgc/dcc/$name"

if [[ -n $release ]]
then
  repo="dcc-release"
  path="$server/$repo/$artifact"
  [[ $release = 1 ]] && version=`curl -s "$path/maven-metadata.xml" | grep latest | sed "s/.*<latest>\([^<]*\)<\/latest>.*/\1/"` || version="$release"
  build=$release
fi
if [[ -n $snapshot ]]
then
  repo="dcc-snapshot"
  path="$server/$repo/$artifact"
  [[ $snapshot = 1 ]] && version=`curl -s "$path/maven-metadata.xml" | grep latest | sed "s/.*<latest>\([^<]*\)<\/latest>.*/\1/"` || version="$snapshot"
  build=`curl -s "$path/$version/maven-metadata.xml" | grep '<value>' | head -1 | sed "s/.*<value>\([^<]*\)<\/value>.*/\1/"`
fi
if [[ -n $pr ]]
then
  repo="dcc-pr-snapshot"
  path="$server/$repo/$artifact"
  [[ $pr = 1 ]] && version=`curl -s "$path/maven-metadata.xml" | grep latest | sed "s/.*<latest>\([^<]*\)<\/latest>.*/\1/"` || version="$pr"
  build=`curl -s "$path/$version/maven-metadata.xml" | grep '<value>' | head -1 | sed "s/.*<value>\([^<]*\)<\/value>.*/\1/"`
fi

# Download and install application
jar="$name-$build.jar"
url="$path/$version/$jar"
log "Downloading jar $url..."
wget -q -N $url -P $libdir
rm -f $libdir/$name.jar
ln -s "$jar" "$libdir/$name.jar"

# Clear cache
log 'Clearing varnish cache...'
response=$(curl --write-out %{http_code} --silent --output /dev/null -XBAN "$cache/")
if [[ $response -ne 200 ]]
then
  log "Failed to clear cache: $response response code"
fi

# Restart application
log 'Restarting application...'
$bindir/dcc-portal-api restart > /dev/null
log 'Finished'